# Copyright 2006 Mark Rose <mkrose@users.sourceforge.net>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

"""
Provides tools for generating Microsoft Visual C project files
from the registered source file definitions.  The output is
currently intended only for browsing and editing the source
code in Visual Studio; support for building directly from
VS has not been implemented.
"""

from csp.tools.build import registry
import random

FILTER = {
 'Header Files': 'h;hpp;hxx;hm;inl;inc;xsd',
 'Source Files': 'cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx',
}

def Generate():
	def addFiles(files, map):
		for f in files: map[f.path] = f

	# todo: add other file types (e.g., swig interfaces)?

	files_by_type = {}
	for name, group in registry.BuildRegistry._sources.iteritems():
		addFiles(group.getHeaders(), files_by_type.setdefault('Header Files', {}))
		addFiles(group.getSources(), files_by_type.setdefault('Source Files', {}))

	vc = open('csp.vcproj', 'wt')
	print >>vc, '<?xml version="1.0" encoding="Windows-1252"?>'
	print >>vc, '<VisualStudioProject'
	print >>vc, '  ProjectType="Visual C++"'
	print >>vc, '  Version="8,00"'
	print >>vc, '  Name="csp"'
	print >>vc, '  ProjectGUID="{A8F54A28-33C4-4E48-A4F4-C15E062C3D50}"'
	print >>vc, '  >'
	print >>vc, '  <Platforms>'
	print >>vc, '    <Platform Name="Win32"/>'
	print >>vc, '  </Platforms>'
	print >>vc, '  <Configurations>'
	print >>vc, '    <Configuration'
	print >>vc, '     Name="Debug|Win32"'
	print >>vc, '     IntermediateDirectory="$(ConfigurationName)"'
	print >>vc, '     ConfigurationType="1"'
	print >>vc, '     >'
	print >>vc, '    </Configuration>'
	print >>vc, '    <Configuration'
	print >>vc, '     Name="Release|Win32"'
	print >>vc, '     IntermediateDirectory="$(ConfigurationName)"'
	print >>vc, '     ConfigurationType="1"'
	print >>vc, '     >'
	print >>vc, '    </Configuration>'
	print >>vc, '  </Configurations>'
	print >>vc, '  <Files>'
	for section, files in files_by_type.iteritems():
		print >>vc, '    <Filter'
		print >>vc, '      Name="%s"' % section
		print >>vc, '      Filter="%s"' % FILTER[section]
		print >>vc, '      UniqueIdentifier="{4FC737F1-C7A5-4376-A066-%012X}"' % random.randint(0, 16**12)
		print >>vc, '      >'
		files = files.values()
		files.sort()
		for f in files:
			print >>vc, '      <File RelativePath="%s"/>' % f.path
		print >>vc, '    </Filter>'
	print >>vc, '  </Files>'
	print >>vc, '</VisualStudioProject>'

	print
	print 'Wrote project definition to csp.vcproj.'
	print
	print 'Note that this project file is only useful for browsing and'
	print 'editing the source code in Microsoft Visual Studio.  To build,'
	print 'run "scons all" from the command line.  The vcproj file must'
	print 'be manually regenerated by running "scons vcproj" whenever the'
	print 'SConstruct/SConscript files change.'
